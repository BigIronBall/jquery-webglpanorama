/*
 * jquery-webglpanorama
 * https://github.com/ulfbiallas/jquery-webglpanorama
 *
 * Copyright (c) 2014-2015 Ulf Biallas
 * Licensed under the MIT license.
 */
!function(e){function t(e){var t=e.context;e.texture_xp=t.createTexture(),e.img_xp=new Image,e.img_xp.onload=function(){r(e,e.img_xp,e.texture_xp)},e.img_xp.src=e.options.xp,e.texture_xn=t.createTexture(),e.img_xn=new Image,e.img_xn.onload=function(){r(e,e.img_xn,e.texture_xn)},e.img_xn.src=e.options.xn,e.texture_yp=t.createTexture(),e.img_yp=new Image,e.img_yp.onload=function(){r(e,e.img_yp,e.texture_yp)},e.img_yp.src=e.options.yp,e.texture_yn=t.createTexture(),e.img_yn=new Image,e.img_yn.onload=function(){r(e,e.img_yn,e.texture_yn)},e.img_yn.src=e.options.yn,e.texture_zp=t.createTexture(),e.img_zp=new Image,e.img_zp.onload=function(){r(e,e.img_zp,e.texture_zp)},e.img_zp.src=e.options.zp,e.texture_zn=t.createTexture(),e.img_zn=new Image,e.img_zn.onload=function(){r(e,e.img_zn,e.texture_zn)},e.img_zn.src=e.options.zn}function r(e,t,r){var n=e.context;n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.MIRRORED_REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.MIRRORED_REPEAT),n.generateMipmap(n.TEXTURE_2D),n.bindTexture(n.TEXTURE_2D,null)}function n(){return"            attribute vec4 aPosition;            attribute vec2 aUV;            uniform mat4 modelviewMatrix;            uniform mat4 projectionMatrix;            varying vec2 vUV;            void main() {                gl_Position = projectionMatrix * modelviewMatrix * aPosition;                vUV = aUV;            }        "}function i(){return"            precision mediump float;            varying vec2 vUV;            uniform sampler2D uSampler;            void main() {                gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);                gl_FragColor = texture2D(uSampler, vUV);            }        "}function a(e){var t=e.context;e.pShader=t.createProgram(),e.vShader=t.createShader(t.VERTEX_SHADER),t.shaderSource(e.vShader,n()),t.compileShader(e.vShader),t.attachShader(e.pShader,e.vShader),e.fShader=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(e.fShader,i()),t.compileShader(e.fShader),t.attachShader(e.pShader,e.fShader),t.linkProgram(e.pShader),t.useProgram(e.pShader)}function o(e){var t=new Float32Array([-1,-1,1,0,1,1,-1,1,1,1,1,1,1,1,0,-1,1,1,0,0,-1,-1,-1,1,1,-1,1,-1,1,0,1,1,-1,0,0,1,-1,-1,0,1,-1,1,-1,0,0,-1,1,1,0,1,1,1,1,1,1,1,1,-1,1,0,-1,-1,-1,0,1,1,-1,-1,1,1,1,-1,1,1,0,-1,-1,1,0,0,1,-1,-1,1,1,1,1,-1,1,0,1,1,1,0,0,1,-1,1,0,1,-1,-1,-1,0,1,-1,-1,1,1,1,-1,1,1,1,0,-1,1,-1,0,0]),r=new Uint16Array([0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20]),n=e.context,i=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW);var a=n.createBuffer();n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,a),n.bufferData(n.ELEMENT_ARRAY_BUFFER,r,n.STATIC_DRAW);var o=n.getAttribLocation(e.pShader,"aPosition"),u=n.getAttribLocation(e.pShader,"aUV");n.enableVertexAttribArray(o),n.enableVertexAttribArray(u),n.vertexAttribPointer(o,3,n.FLOAT,!1,20,0),n.vertexAttribPointer(u,2,n.FLOAT,!1,20,12)}function u(e){var t=e.context,r=Math.cos(Math.PI*e.phi/180)*Math.cos(Math.PI*e.theta/180),n=Math.sin(Math.PI*e.theta/180),i=Math.sin(Math.PI*e.phi/180)*Math.cos(Math.PI*e.theta/180),a=new h(r,n,i),o=new h(0,0,0),m=new s;m.lookAt(o,o.add(a),new h(0,1,0));var _=new s,c=t.drawingBufferWidth/t.drawingBufferHeight;_.perspective(e.options.fov,c,.1,2),t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT),t.uniformMatrix4fv(t.getUniformLocation(e.pShader,"modelviewMatrix"),!1,m.data()),t.uniformMatrix4fv(t.getUniformLocation(e.pShader,"projectionMatrix"),!1,_.data()),t.uniform1i(t.getUniformLocation(e.pShader,"uSampler"),0),t.bindTexture(t.TEXTURE_2D,e.texture_zp),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0),t.bindTexture(t.TEXTURE_2D,e.texture_zn),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,12),t.bindTexture(t.TEXTURE_2D,e.texture_yp),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,24),t.bindTexture(t.TEXTURE_2D,e.texture_yn),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,36),t.bindTexture(t.TEXTURE_2D,e.texture_xp),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,48),t.bindTexture(t.TEXTURE_2D,e.texture_xn),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,60),e.animationId=requestAnimationFrame(function(){return u(e)})}function s(){this.values=new Float32Array(16),this.setToZero=function(){var e;for(e=0;16>e;++e)this.values[e]=0},this.setToIdentity=function(){var e;for(e=0;16>e;++e)this.values[e]=0;for(e=0;4>e;++e)this.values[4*e+e]=1},this.lookAt=function(e,t,r){if(0==e.sub(t).norm2())this.setToIdentity();else{var n=t.sub(e).normalize(),i=r.normalize(),a=n.cross(i).normalize(),o=a.cross(n).normalize();this.values[0]=a.x,this.values[4]=a.y,this.values[8]=a.z,this.values[1]=o.x,this.values[5]=o.y,this.values[9]=o.z,this.values[2]=-n.x,this.values[6]=-n.y,this.values[10]=-n.z,this.values[3]=0,this.values[7]=0,this.values[11]=0,this.values[15]=1,this.values[12]=-a.dot(e),this.values[13]=-o.dot(e),this.values[14]=n.dot(e)}},this.perspective=function(e,t,r,n){this.setToZero();var i=m(e*Math.PI/360);this.values[0]=i/t,this.values[5]=i,this.values[10]=(n+r)/(r-n),this.values[11]=-1,this.values[14]=2*n*r/(r-n)},this.data=function(){return this.values}}function h(e,t,r){this.x=e,this.y=t,this.z=r,this.add=function(n){return new h(e+n.x,t+n.y,r+n.z)},this.sub=function(n){return new h(e-n.x,t-n.y,r-n.z)},this.dot=function(n){return e*n.x+t*n.y+r*n.z},this.scale=function(n){return new h(e*n,t*n,r*n)},this.cross=function(n){return new h(t*n.z-r*n.y,r*n.x-e*n.z,e*n.y-t*n.x)},this.norm2=function(){return e*e+t*t+r*r},this.norm=function(){return Math.sqrt(this.norm2())},this.normalize=function(){var e=this.norm();return e>0?this.scale(1/e):this}}function m(e){return 1/Math.tan(e)}e.fn.panorama=function(r){return this.each(function(){var n={fov:90};e.extend(n,r);var i={context:"",vShader:"",fShader:"",pShader:"",animationId:0,phi:-90,phiOld:0,theta:0,thetaOld:0,mousedown:!1,mousePosX:0,mousePosY:0,mousePosOldX:0,mousePosOldY:0,texture_xn:"",texture_xp:"",texture_yn:"",texture_yp:"",texture_zn:"",texture_zp:"",img_xp:"",img_xn:"",img_yp:"",img_yn:"",img_zp:"",img_zn:"",options:n};e(this).mousemove(function(e){i.mousedown&&(i.mousePosX=e.pageX,i.mousePosY=e.pageY,i.phi=i.phiOld+.2*(i.mousePosX-i.mousePosOldX),i.theta=i.thetaOld-.2*(i.mousePosY-i.mousePosOldY),i.theta>90&&(i.theta=90),i.theta<-90&&(i.theta=-90))}),e(this).mousedown(function(e){i.mousedown=!0,i.phiOld=i.phi,i.thetaOld=i.theta,i.mousePosOldX=e.pageX,i.mousePosOldY=e.pageY}),e(this).mouseup(function(){i.mousedown=!1}),e(this).mouseout(function(){i.mousedown=!1}),i.context=this.getContext("experimental-webgl"),t(i),a(i),o(i),i.animationId=requestAnimationFrame(function(){return u(i)})}),this}}(jQuery);