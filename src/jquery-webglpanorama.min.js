/*
 * jquery-webglpanorama
 * https://github.com/ulfbiallas/jquery-webglpanorama
 *
 * Copyright (c) 2014-2015 Ulf Biallas
 * Licensed under the MIT license.
 */
!function(t){function e(t){for(var e=t.context,r=(t.options.images.length,0);2>r;++r)t.textures.push({xp:"",xn:"",yp:"",yn:"",zp:"",zn:""}),t.textures[r].xp=new Image,t.textures[r].xp.tex=e.createTexture(),t.textures[r].xp.onload=function(){a(e,this)},t.textures[r].xp.src=t.options.images[r].xp,t.textures[r].xn=new Image,t.textures[r].xn.tex=e.createTexture(),t.textures[r].xn.onload=function(){a(e,this)},t.textures[r].xn.src=t.options.images[r].xn,t.textures[r].yp=new Image,t.textures[r].yp.tex=e.createTexture(),t.textures[r].yp.onload=function(){a(e,this)},t.textures[r].yp.src=t.options.images[r].yp,t.textures[r].yn=new Image,t.textures[r].yn.tex=e.createTexture(),t.textures[r].yn.onload=function(){a(e,this)},t.textures[r].yn.src=t.options.images[r].yn,t.textures[r].zp=new Image,t.textures[r].zp.tex=e.createTexture(),t.textures[r].zp.onload=function(){a(e,this)},t.textures[r].zp.src=t.options.images[r].zp,t.textures[r].zn=new Image,t.textures[r].zn.tex=e.createTexture(),t.textures[r].zn.onload=function(){a(e,this)},t.textures[r].zn.src=t.options.images[r].zn}function a(t,e){t.bindTexture(t.TEXTURE_2D,e.tex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.MIRRORED_REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.MIRRORED_REPEAT),t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null)}function r(){return"            attribute vec4 aPosition;            attribute vec2 aUV;            uniform mat4 modelviewMatrix;            uniform mat4 projectionMatrix;            varying vec2 vUV;            void main() {                gl_Position = projectionMatrix * modelviewMatrix * aPosition;                vUV = aUV;            }        "}function n(){return"            precision mediump float;            varying vec2 vUV;            uniform sampler2D uSampler;            void main() {                gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);                gl_FragColor = texture2D(uSampler, vUV);            }        "}function i(t){var e=t.context;t.pShader=e.createProgram(),t.vShader=e.createShader(e.VERTEX_SHADER),e.shaderSource(t.vShader,r()),e.compileShader(t.vShader),e.attachShader(t.pShader,t.vShader),t.fShader=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(t.fShader,n()),e.compileShader(t.fShader),e.attachShader(t.pShader,t.fShader),e.linkProgram(t.pShader),e.useProgram(t.pShader)}function o(t){var e=new Float32Array([-1,-1,1,0,1,1,-1,1,1,1,1,1,1,1,0,-1,1,1,0,0,-1,-1,-1,1,1,-1,1,-1,1,0,1,1,-1,0,0,1,-1,-1,0,1,-1,1,-1,0,0,-1,1,1,0,1,1,1,1,1,1,1,1,-1,1,0,-1,-1,-1,0,1,1,-1,-1,1,1,1,-1,1,1,0,-1,-1,1,0,0,1,-1,-1,1,1,1,1,-1,1,0,1,1,1,0,0,1,-1,1,0,1,-1,-1,-1,0,1,-1,-1,1,1,1,-1,1,1,1,0,-1,1,-1,0,0]),a=new Uint16Array([0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20]),r=t.context,n=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW);var i=r.createBuffer();r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,i),r.bufferData(r.ELEMENT_ARRAY_BUFFER,a,r.STATIC_DRAW);var o=r.getAttribLocation(t.pShader,"aPosition"),s=r.getAttribLocation(t.pShader,"aUV");r.enableVertexAttribArray(o),r.enableVertexAttribArray(s),r.vertexAttribPointer(o,3,r.FLOAT,!1,20,0),r.vertexAttribPointer(s,2,r.FLOAT,!1,20,12)}function s(t){var e=t.context,a=Math.cos(Math.PI*t.phi/180)*Math.cos(Math.PI*t.theta/180),r=Math.sin(Math.PI*t.theta/180),n=Math.sin(Math.PI*t.phi/180)*Math.cos(Math.PI*t.theta/180),i=new h(a,r,n),o=new h(0,0,0),d=new u;d.lookAt(o,o.add(i),new h(0,1,0));var m=new u,x=e.drawingBufferWidth/e.drawingBufferHeight;m.perspective(t.options.fov,x,.1,2),e.clearColor(1,1,1,1),e.clear(e.COLOR_BUFFER_BIT),e.uniformMatrix4fv(e.getUniformLocation(t.pShader,"modelviewMatrix"),!1,d.data()),e.uniformMatrix4fv(e.getUniformLocation(t.pShader,"projectionMatrix"),!1,m.data()),e.uniform1i(e.getUniformLocation(t.pShader,"uSampler"),0),e.bindTexture(e.TEXTURE_2D,t.textures[t.panoramaId].zp.tex),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),e.bindTexture(e.TEXTURE_2D,t.textures[t.panoramaId].zn.tex),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,12),e.bindTexture(e.TEXTURE_2D,t.textures[t.panoramaId].yp.tex),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,24),e.bindTexture(e.TEXTURE_2D,t.textures[t.panoramaId].yn.tex),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,36),e.bindTexture(e.TEXTURE_2D,t.textures[t.panoramaId].xp.tex),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,48),e.bindTexture(e.TEXTURE_2D,t.textures[t.panoramaId].xn.tex),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,60),t.animationId=requestAnimationFrame(function(){return s(t)})}function u(){this.values=new Float32Array(16),this.setToZero=function(){var t;for(t=0;16>t;++t)this.values[t]=0},this.setToIdentity=function(){var t;for(t=0;16>t;++t)this.values[t]=0;for(t=0;4>t;++t)this.values[4*t+t]=1},this.lookAt=function(t,e,a){if(0==t.sub(e).norm2())this.setToIdentity();else{var r=e.sub(t).normalize(),n=a.normalize(),i=r.cross(n).normalize(),o=i.cross(r).normalize();this.values[0]=i.x,this.values[4]=i.y,this.values[8]=i.z,this.values[1]=o.x,this.values[5]=o.y,this.values[9]=o.z,this.values[2]=-r.x,this.values[6]=-r.y,this.values[10]=-r.z,this.values[3]=0,this.values[7]=0,this.values[11]=0,this.values[15]=1,this.values[12]=-i.dot(t),this.values[13]=-o.dot(t),this.values[14]=r.dot(t)}},this.perspective=function(t,e,a,r){this.setToZero();var n=d(t*Math.PI/360);this.values[0]=n/e,this.values[5]=n,this.values[10]=(r+a)/(a-r),this.values[11]=-1,this.values[14]=2*r*a/(a-r)},this.data=function(){return this.values}}function h(t,e,a){this.x=t,this.y=e,this.z=a,this.add=function(r){return new h(t+r.x,e+r.y,a+r.z)},this.sub=function(r){return new h(t-r.x,e-r.y,a-r.z)},this.dot=function(r){return t*r.x+e*r.y+a*r.z},this.scale=function(r){return new h(t*r,e*r,a*r)},this.cross=function(r){return new h(e*r.z-a*r.y,a*r.x-t*r.z,t*r.y-e*r.x)},this.norm2=function(){return t*t+e*e+a*a},this.norm=function(){return Math.sqrt(this.norm2())},this.normalize=function(){var t=this.norm();return t>0?this.scale(1/t):this}}function d(t){return 1/Math.tan(t)}t.fn.panorama=function(a){return this.each(function(){var r={fov:90};t.extend(r,a),this.webglpanoramadata={context:"",vShader:"",fShader:"",pShader:"",animationId:0,phi:-90,phiOld:0,theta:0,thetaOld:0,mousedown:!1,mousePosX:0,mousePosY:0,mousePosOldX:0,mousePosOldY:0,textures:[],panoramaId:1,options:r};var n=this.webglpanoramadata;t(this).mousemove(function(t){n.mousedown&&(n.mousePosX=t.pageX,n.mousePosY=t.pageY,n.phi=n.phiOld+.2*(n.mousePosX-n.mousePosOldX),n.theta=n.thetaOld-.2*(n.mousePosY-n.mousePosOldY),n.theta>90&&(n.theta=90),n.theta<-90&&(n.theta=-90))}),t(this).mousedown(function(t){n.mousedown=!0,n.phiOld=n.phi,n.thetaOld=n.theta,n.mousePosOldX=t.pageX,n.mousePosOldY=t.pageY}),t(this).mouseup(function(){n.mousedown=!1}),t(this).mouseout(function(){n.mousedown=!1}),n.context=this.getContext("experimental-webgl"),e(n),i(n),o(n),n.animationId=requestAnimationFrame(function(){return s(n)})}),this},t.fn.previous=function(){this.each(function(){this.webglpanoramadata.panoramaId>0&&this.webglpanoramadata.panoramaId--})},t.fn.next=function(){this.each(function(){this.webglpanoramadata.panoramaId<this.webglpanoramadata.textures.length-1&&this.webglpanoramadata.panoramaId++})}}(jQuery);